// =============================================
// Prisma Schema — iShine Wireless B2B Backend
// =============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// ─── ENUMS ──────────────────────────────────

enum Role {
  ADMIN
  CUSTOMER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

// ─── USER ───────────────────────────────────

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  role          Role     @default(CUSTOMER)

  // B2B Business Details
  businessName  String?
  businessPhone String?
  taxId         String?
  companyAddress String?

  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  orders        Order[]

  @@map("users")
}

// ─── CATEGORY (Recursive / Self-Referencing) ─

model Category {
  id          String     @id @default(uuid())
  name        String
  slug        String     @unique
  description String?    @db.Text
  image       String?    // URL to category image

  // Self-referencing relation for unlimited nesting
  // e.g. Apple > iPhone > iPhone 15 > Screens
  parentId    String?
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryTree")

  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  products    Product[]

  @@index([parentId])
  @@index([slug])
  @@map("categories")
}

// ─── PRODUCT ────────────────────────────────

model Product {
  id              String   @id @default(uuid())
  sku             String   @unique
  name            String
  slug            String   @unique
  description     String?  @db.Text
  shortDescription String? @db.VarChar(500)

  wholesalePrice  Decimal  @db.Decimal(10, 2)
  retailPrice     Decimal  @db.Decimal(10, 2)
  costPrice       Decimal? @db.Decimal(10, 2)

  stock           Int      @default(0)
  lowStockThreshold Int    @default(10)

  // JSON array of image URLs: ["url1", "url2", ...]
  images          Json     @default("[]")

  // Bullets and customer reviews
  features        Json     @default("[]")
  reviews         Json     @default("[]")

  // Product metadata
  weight          Decimal? @db.Decimal(8, 2)
  brand           String?
  warranty        String?
  compatibility   String?  @db.Text // e.g. "iPhone 14 Pro Max, iPhone 14 Pro"

  isFeatured      Boolean  @default(false)
  isActive        Boolean  @default(true)

  categoryId      String
  category        Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  orderItems      OrderItem[]

  @@index([categoryId])
  @@index([sku])
  @@index([slug])
  @@map("products")
}

// ─── ORDER ──────────────────────────────────

model Order {
  id              String      @id @default(uuid())
  orderNumber     String      @unique // e.g. ISW-20260225-0001
  status          OrderStatus @default(PENDING)

  totalAmount     Decimal     @db.Decimal(12, 2)
  subtotal        Decimal     @db.Decimal(12, 2)
  tax             Decimal     @default(0) @db.Decimal(10, 2)
  shippingCost    Decimal     @default(0) @db.Decimal(10, 2)
  discount        Decimal     @default(0) @db.Decimal(10, 2)

  // Shipping Details
  shippingAddress String      @db.Text
  shippingCity    String
  shippingState   String
  shippingZip     String
  shippingCountry String      @default("US")
  shippingMethod  String?

  // Payment
  paymentMethod   String?
  paymentStatus   String      @default("unpaid")

  notes           String?     @db.Text

  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  items           OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

// ─── ORDER ITEM ─────────────────────────────

model OrderItem {
  id          String  @id @default(uuid())
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  totalPrice  Decimal @db.Decimal(12, 2)

  orderId     String
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId   String
  product     Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ─── SITE SETTINGS ──────────────────────────
// Key-value store for admin-controlled global data
// e.g. key: "hero_banner", value: { title: "...", image: "..." }

model SiteSettings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  group     String   @default("general") // group settings: "general", "banners", "contact", "seo"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([group])
  @@map("site_settings")
}
